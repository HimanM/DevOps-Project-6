name: Build and Deploy

on:
  push:
    branches: [ "main" ]
    # paths:
    #   - 'frontend/**'
    #   - 'backend/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check for changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'

      - name: Log in to the Container registry
        if: steps.changes.outputs.frontend == 'true' || steps.changes.outputs.backend == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Frontend Build & Push
      - name: Extract metadata (tags, labels) for Frontend
        if: steps.changes.outputs.frontend == 'true'
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: type=sha,format=short

      - name: Build and push Frontend
        if: steps.changes.outputs.frontend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

      # Backend Build & Push
      - name: Extract metadata (tags, labels) for Backend
        if: steps.changes.outputs.backend == 'true'
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: type=sha,format=short

      - name: Build and push Backend
        if: steps.changes.outputs.backend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}

      # Update Manifests & Push
      - name: Update Manifests and Push
        if: steps.changes.outputs.frontend == 'true' || steps.changes.outputs.backend == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Update Frontend Manifest
          if [ "${{ steps.changes.outputs.frontend }}" == "true" ]; then
            NEW_TAG=${{ steps.meta-frontend.outputs.version }}
            NEW_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${NEW_TAG}"
            echo "Updating Frontend to ${NEW_IMAGE}"
            sed -i "s|image: .*frontend:.*|image: ${NEW_IMAGE}|" manifests/frontend-deployment.yaml
            git add manifests/frontend-deployment.yaml
          fi
          
          # Update Backend Manifest
          if [ "${{ steps.changes.outputs.backend }}" == "true" ]; then
            NEW_TAG=${{ steps.meta-backend.outputs.version }}
            NEW_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${NEW_TAG}"
            echo "Updating Backend to ${NEW_IMAGE}"
            sed -i "s|image: .*backend:.*|image: ${NEW_IMAGE}|" manifests/backend-deployment.yaml
            git add manifests/backend-deployment.yaml
          fi
          
          # Commit and Push
          git commit -m "Update manifests with new image tags" || echo "No changes to commit"
          git push
